{% extends "base.html" %} 
{% block title %}المنتجات - متجر العبايات{% endblock %} 

{% block content %}
<div class="container py-5">
  <div class="row">
    <!-- الشريط الجانبي للتصفية -->
    <div class="col-md-3">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">تصفية المنتجات</h5>
        </div>
        <div class="card-body">
          <form id="filter-form">
            <!-- البحث -->
            <div class="mb-3">
              <label for="search" class="form-label">البحث</label>
              <input
                type="text"
                class="form-control"
                id="search"
                name="q"
                value="{{ request.args.get('q', '') }}"
              />
            </div>

            <!-- الفئة -->
            <div class="mb-3">
              <label class="form-label">الفئة</label>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="category"
                  id="category-all"
                  value=""
                  checked
                />
                <label class="form-check-label" for="category-all">الكل</label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="category"
                  id="category-classic"
                  value="classic"
                />
                <label class="form-check-label" for="category-classic"
                  >عبايات كلاسيكية</label
                >
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="category"
                  id="category-modern"
                  value="modern"
                />
                <label class="form-check-label" for="category-modern"
                  >عبايات عصرية</label
                >
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="category"
                  id="category-accessories"
                  value="accessories"
                />
                <label class="form-check-label" for="category-accessories"
                  >إكسسوارات</label
                >
              </div>
            </div>

            <!-- السعر -->
            <div class="mb-3">
              <label class="form-label">نطاق السعر</label>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="price"
                  id="price-all"
                  value=""
                  checked
                />
                <label class="form-check-label" for="price-all">الكل</label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="price"
                  id="price-1"
                  value="0-100"
                />
                <label class="form-check-label" for="price-1"
                  >حتى 100 ر.س</label
                >
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="price"
                  id="price-2"
                  value="100-200"
                />
                <label class="form-check-label" for="price-2"
                  >100 - 200 ر.س</label
                >
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="price"
                  id="price-3"
                  value="200-500"
                />
                <label class="form-check-label" for="price-3"
                  >200 - 500 ر.س</label
                >
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="price"
                  id="price-4"
                  value="500+"
                />
                <label class="form-check-label" for="price-4"
                  >أكثر من 500 ر.س</label
                >
              </div>
            </div>

            <!-- التصنيف حسب -->
            <div class="mb-3">
              <label for="sort" class="form-label">ترتيب حسب</label>
              <select class="form-select" id="sort" name="sort">
                <option value="newest">الأحدث</option>
                <option value="price-low">السعر: من الأقل للأعلى</option>
                <option value="price-high">السعر: من الأعلى للأقل</option>
                <option value="name">الاسم: أ-ي</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">
              تطبيق الفلتر
            </button>
            <button type="reset" class="btn btn-outline-secondary w-100 mt-2">
              إعادة الضبط
            </button>
          </form>
        </div>
      </div>

      <!-- إعلان -->
      <div class="card mb-4">
        <div class="card-body text-center">
          <h5>خصم يصل إلى 30%</h5>
          <p>على تشكيلة العبايات العصرية</p>
          <a href="{{ url_for('offers') }}" class="btn btn-danger"
            >استفد الآن</a
          >
        </div>
      </div>
    </div>

    <!-- المنتجات -->
    <div class="col-md-9">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>جميع المنتجات</h2>
        <div class="d-flex align-items-center">
          <span class="me-2">عرض:</span>
          <select class="form-select form-select-sm w-auto">
            <option value="12">12</option>
            <option value="24">24</option>
            <option value="36">36</option>
          </select>
        </div>
      </div>

      <div class="row">
        {% for product in products %}
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="card h-100 product-card">
            {% if product.discount %}
            <div class="badge bg-danger position-absolute m-2">
              خصم {{ product.discount }}%
            </div>
            {% endif %}
            
            <img 
              src="{{ url_for('static', filename='uploads/products/' + product.primary_image) }}" 
              class="card-img-top" 
              alt="{{ product.name }}"
              style="height: 300px; object-fit: cover;"
            >

            <div class="card-body">
              <h5 class="card-title">{{ product.name }}</h5>
              <p class="card-text text-muted">
                {{ product.description[:60] }}...
              </p>

              <div class="d-flex justify-content-between align-items-center">
                {% if product.discount %}
                <div>
                  <span class="h5 text-primary">
                    {{ product.price - (product.price * product.discount / 100) }} ر.س
                  </span>
                  <span class="text-muted text-decoration-line-through ms-2">
                    {{ product.price }} ر.س
                  </span>
                </div>
                {% else %}
                <span class="h5 text-primary">{{ product.price }} ر.س</span>
                {% endif %}
                
                {% if product.stock > 0 %}
                <span class="badge bg-success">متوفر</span>
                {% else %}
                <span class="badge bg-danger">غير متوفر</span>
                {% endif %}
              </div>
            </div>

            <div class="card-footer bg-white">
              <div class="d-grid gap-2">
                <a
                  href="{{ url_for('product_detail', id=product.id) }}"
                  class="btn btn-outline-primary"
                  >عرض التفاصيل</a
                >
                {% if product.stock > 0 %}
                <form
                  action="{{ url_for('add_to_cart', product_id=product.id) }}"
                  method="POST"
                >
                  <button type="submit" class="btn btn-primary w-100">
                    أضف إلى السلة
                  </button>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- التصفح -->
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1">السابق</a>
          </li>
          <li class="page-item active"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">3</a></li>
          <li class="page-item">
            <a class="page-link" href="#">التالي</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // تعيين القيم الحالية للفلتر
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.has("category")) {
      const category = urlParams.get("category");
      document.querySelector(
        `input[name="category"][value="${category}"]`
      ).checked = true;
    }

    if (urlParams.has("price")) {
      const price = urlParams.get("price");
      document.querySelector(
        `input[name="price"][value="${price}"]`
      ).checked = true;
    }

    if (urlParams.has("sort")) {
      document.getElementById("sort").value = urlParams.get("sort");
    }

    // إرسال النموذج عند تغيير الفلتر
    document
      .getElementById("filter-form")
      .addEventListener("change", function () {
        this.submit();
      });
  });
</script>
{% endblock %}